<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>Every</title><meta name="description" content="浮生一薤露，蜗角争是非"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a class="current" href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li><li> <a href="/links">Links</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)" style="display:none;"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li></div><div class="avatar"><img src="/images/avatar.png"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:220px;" alt="favicon"><h3 title=""><a href="/">Every</a></h3><div class="description"><p>浮生一薤露，蜗角争是非</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/mziopo"><i class="fa fa-github"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span>  </span><span> </span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/08/22/jsoup/">Jsoup Java 爬虫</a></h3></div><div class="post-content"><div class="card"><p><hr>
<h2 id="README">README</h2>
<p>本篇主要记录Jsoup学习笔记</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;https://search.jd.com/Search?keyword=java&quot;</span>;</span><br><span class="line">    <span class="type">Document</span> <span class="variable">document</span> <span class="operator">=</span> Jsoup.parse(<span class="keyword">new</span> <span class="title class_">URL</span>(url), <span class="number">3000</span>);</span><br><span class="line">    <span class="type">Element</span> <span class="variable">element</span> <span class="operator">=</span> document.getElementById(<span class="string">&quot;J_goodsList&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (element != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Elements</span> <span class="variable">lis</span> <span class="operator">=</span> element.getElementsByTag(<span class="string">&quot;li&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Element li : lis) &#123;</span><br><span class="line">            <span class="comment">//图片懒加载 取src取不到的</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">img</span> <span class="operator">=</span> li.getElementsByTag(<span class="string">&quot;img&quot;</span>).attr(<span class="string">&quot;data-lazy-img&quot;</span>);</span><br><span class="line">            System.out.println(img);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//println:</span></span><br><span class="line"><span class="comment">//img11.360buyimg.com/n7/jfs/t1/82473/36/24163/66491/64ad137eF3177ad97/d4bc56fe5f0de60b.jpg</span></span><br><span class="line"><span class="comment">//img12.360buyimg.com/n7/jfs/t1/93147/2/36396/122771/64d30740F04ca7fbb/0563559dd3991401.jpg</span></span><br><span class="line"><span class="comment">//img11.360buyimg.com/n7/jfs/t1/165807/14/35043/57871/64a65941F7c41f21c/580193f21ab25f4a.jpg</span></span><br><span class="line"><span class="comment">//img14.360buyimg.com/n7/jfs/t1/143580/7/37074/72892/64bc9332Fe4305497/28c5bc4a54950f8d.jpg</span></span><br><span class="line"><span class="comment">//img12.360buyimg.com/n7/jfs/t1/173641/3/39545/79502/64d30008Fe05efef3/49c4b51506410cd0.jpg</span></span><br><span class="line"><span class="comment">//img14.360buyimg.com/n7/jfs/t1/93147/2/36396/122771/64d30740F04ca7fbb/0563559dd3991401.jpg</span></span><br><span class="line"><span class="comment">//img14.360buyimg.com/n7/jfs/t1/4484/1l/21825/65279/6455f622F2d1b9860/d0551b7453604c15.jpg</span></span><br><span class="line"><span class="comment">//img13.360buyimg.com/n7/jfs/t1/110197/24/37538/237025/6402328eF64f34394/0118b7bfd3f661b8.jpg</span></span><br><span class="line"><span class="comment">//img13.360buyimg.com/n7/jfs/t1/123613/39/34171/61413/64bc9564F02d8e3a2/1b41a57175756482.jpg</span></span><br><span class="line"><span class="comment">//img12.360buyimg.com/n7/jfs/t1/189387/15/35208/73395/64b26ccfF370691bc/4c786d4342bfcdcd.jpg</span></span><br></pre></td></tr></table></figure>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-08-22</span><a class="tag" href="/categories/Spider/" title="Spider">Spider </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Spider/" title="Spider">Spider </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Jsoup/" title="Jsoup">Jsoup </a><span class="leancloud_visitors"></span><span>About 227 words, 45 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/08/22/redis/">Redis 笔记</a></h3></div><div class="post-content"><div class="card"><p><hr>
<h2 id="README">README</h2>
<p>本篇主要记录Redis学习笔记</p>
<hr>
<h2 id="字符串-string">字符串 string</h2>
<p><code>set msg &quot;hello world&quot;</code></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>append key value</td>
<td>向指定的 key 的 value 后追加字符串</td>
<td></td>
</tr>
<tr>
<td>incr / decr key</td>
<td>将指定 key 的 value 数值进行 +1 / -1</td>
<td></td>
</tr>
<tr>
<td>incrby / decrby key n</td>
<td>按指定的步长对数值进行加减</td>
<td></td>
</tr>
<tr>
<td>incrbyfloat key n</td>
<td>为数值加上浮点型数值</td>
<td></td>
</tr>
<tr>
<td>strlen key</td>
<td>获取 key 保存值的字符串长度</td>
<td></td>
</tr>
<tr>
<td>getrange key start end</td>
<td>按起止位置获取字符串</td>
<td>getrange msg 3 9 &gt; “lo worl”</td>
</tr>
<tr>
<td>setrange key offset value</td>
<td>用指定的 value 替换 key 中 offset 开始的值</td>
<td>setrange msg 2 hello &gt; “hehello”</td>
</tr>
<tr>
<td>getset key value</td>
<td>将给定 key 的值设为 value 并返回 old value</td>
<td>getset msg xxx &gt; “hello world”</td>
</tr>
<tr>
<td>setnx key value</td>
<td>仅当key不存在时进行set</td>
<td></td>
</tr>
<tr>
<td>setex key seconds value</td>
<td>set 键值对并设置过期时间</td>
<td></td>
</tr>
<tr>
<td>mset key1 value1 [key2 value2…]</td>
<td>批量set键值对</td>
<td></td>
</tr>
<tr>
<td>msetnx key1 value1 [key2 value2…]</td>
<td>批量设置键值对，仅当参数中所有的key都不存在时执行</td>
<td></td>
</tr>
<tr>
<td>mget key1 [key2…]</td>
<td>批量获取多个key保存的值</td>
<td></td>
</tr>
<tr>
<td>psetex key milliseconds value</td>
<td>set 键值对并设置毫秒过期时间</td>
<td></td>
</tr>
</tbody>
</table>
<hr>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-08-22</span><a class="tag" href="/categories/Redis/" title="Redis">Redis </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Redis/" title="Redis">Redis </a><span class="leancloud_visitors"></span><span>About 274 words, 54 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/08/18/vm-ubuntu/">Windows环境VM中安装Ubuntu 23.04</a></h3></div><div class="post-content"><div class="card"><p><hr>
<h2 id="准备镜像">准备镜像</h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/">https://mirrors.tuna.tsinghua.edu.cn/</a></p>
<p>ubuntu-23.04-desktop-amd64.iso</p>
</blockquote>
<hr>
<h2 id="安装VM17">安装VM17</h2>
<blockquote>
<p>MC60H-DWHD5-H80U9-6V85M-8280D</p>
</blockquote>
<hr>
<h2 id="VM中安装Ubuntu">VM中安装Ubuntu</h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qyfx123456/article/details/130190155">https://blog.csdn.net/qyfx123456/article/details/130190155</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#（vm中复制粘贴用）</span></span><br><span class="line">sudo apt-get install open-vm-tools-desktop -y</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Ubuntu中安装Docker">Ubuntu中安装Docker</h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a></p>
</blockquote>
<hr>
<h2 id="Ubuntu中安装JDK8">Ubuntu中安装JDK8</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install openjdk-8-jdk</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Ubuntu中安装Redis">Ubuntu中安装Redis</h2>
<ol>
<li>安装</li>
</ol>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/764565">https://developer.aliyun.com/article/764565</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install redis-server</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>注释bind</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/redis/redis.conf</span><br><span class="line"><span class="comment"># bind 127.0.0.1</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>设置密码</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/redis/redis.conf</span><br><span class="line"><span class="comment"># requierpass 123</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>通过防火墙</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow proto tcp from 192.168.58.1/24 to any port 6379</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>开机自启动</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> redis-server</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Ubuntu中安装MySQL">Ubuntu中安装MySQL</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mysql-server</span><br><span class="line"><span class="comment"># 防火墙 allow</span></span><br><span class="line">sudo ufw allow mysql</span><br><span class="line">sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf</span><br><span class="line">bind-address 0.0.0.0</span><br><span class="line"><span class="comment"># mysql</span></span><br><span class="line">mysql</span><br><span class="line">use mysql;</span><br><span class="line"><span class="built_in">set</span> global validate_password.policy=0;</span><br><span class="line"><span class="built_in">set</span> global validate_password.length=3;</span><br><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">update user <span class="built_in">set</span> host = <span class="string">&#x27;%&#x27;</span> <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"><span class="comment"># restart</span></span><br><span class="line">sudo systemctl restart mysql</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Docker中安装Nacos">Docker中安装Nacos</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim Dokcerfile</span><br><span class="line"><span class="comment"># Dockerfile</span></span><br><span class="line">FROM nacos/nacos-server:latest</span><br><span class="line">EXPOSE 8848</span><br><span class="line">ENV MODE standalone</span><br><span class="line">ENV LANG en_US.UTF-8</span><br><span class="line">ENV LANGUAGE en_US.UTF-8</span><br><span class="line">ENV LC_ALL en_US.UTF-8</span><br><span class="line">CMD [<span class="string">&quot;nacos&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># build</span></span><br><span class="line">docker build -t nacos .</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># run</span></span><br><span class="line">docker run --name nacos --restart=always -d -p 8848:8848 nacos</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ufw</span></span><br><span class="line">sudo ufw allow proto tcp from 192.168.58.1/24 to any port 8848</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl</span></span><br><span class="line">curl localhost:8848/nacos</span><br></pre></td></tr></table></figure></p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-08-18</span><a class="tag" href="/categories/Ubuntu/" title="Ubuntu">Ubuntu </a><a class="tag" href="/categories/Ubuntu/VM/" title="VM">VM </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Ubuntu/" title="Ubuntu">Ubuntu </a><i class="fa fa-tag"></i><a class="tag" href="/tags/VM/" title="VM">VM </a><span class="leancloud_visitors"></span><span>About 268 words, 53 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/08/18/design-model/">设计模式笔记</a></h3></div><div class="post-content"><div class="card"><p><hr>
<blockquote>
<p>Spring中涉及的设计模式总结</p>
</blockquote>
<h2 id="简单工厂-非23种设计模式中的一种">简单工厂(非23种设计模式中的一种)</h2>
<h3 id="b-style-color-skyblue-实现方式：-b"><b style="color:skyblue">实现方式：</b></h3>
<p>BeanFactory。Spring中的BeanFactory就是简单工厂模式的体现，根据传入一个唯一的标识来获得Bean对象，但是否是在传入参数后创建还是传入参数前创建这个要根据具体情况来定。</p>
<h3 id="b-style-color-skyblue-实质：-b"><b style="color:skyblue">实质：</b></h3>
<p>由一个工厂类根据传入的参数，动态决定应该创建哪一个产品类。</p>
<h3 id="b-style-color-skyblue-实现原理：-b"><b style="color:skyblue">实现原理：</b></h3>
<p><strong>bean容器的启动阶段</strong>：</p>
<ul>
<li>读取bean的xml配置文件,将bean元素分别转换成一个BeanDefinition对象。</li>
<li>然后通过BeanDefinitionRegistry将这些bean注册到beanFactory中，保存在它的一个ConcurrentHashMap中。</li>
<li>将BeanDefinition注册到了beanFactory之后，在这里Spring为我们提供了一个扩展的切口，允许我们通过实现接口BeanFactoryPostProcessor<br>
在此处来插入我们定义的代码。典型的例子就是：PropertyPlaceholderConfigurer，我们一般在配置数据库的dataSource时使用到的占位符的值，就是它注入进去的。</li>
</ul>
<p><strong>容器中bean的实例化阶段</strong>：</p>
<p>实例化阶段主要是通过反射或者CGLIB对bean进行实例化，在这个阶段Spring又给我们暴露了很多的扩展点：</p>
<ul>
<li><strong>各种的Aware接口</strong> ，比如 BeanFactoryAware，对于实现了这些Aware接口的bean，在实例化bean时Spring会帮我们注入对应的BeanFactory的实例。</li>
<li><strong>BeanPostProcessor接口</strong> ，实现了BeanPostProcessor接口的bean，在实例化bean时Spring会帮我们调用接口中的方法。</li>
<li><strong>InitializingBean接口</strong> ，实现了InitializingBean接口的bean，在实例化bean时Spring会帮我们调用接口中的方法。</li>
<li><strong>DisposableBean接口</strong> ，实现了BeanPostProcessor接口的bean，在该bean死亡时Spring会帮我们调用接口中的方法。</li>
</ul>
<h3 id="b-style-color-skyblue-设计意义：-b"><b style="color:skyblue">设计意义：</b></h3>
<p><strong>松耦合。</strong><br>
可以将原来硬编码的依赖，通过Spring这个beanFactory这个工厂来注入依赖，也就是说原来只有依赖方和被依赖方，现在我们引入了第三方——spring这个beanFactory，由它来解决bean之间的依赖问题，达到了松耦合的效果.</p>
<p><strong>bean的额外处理。</strong><br>
通过Spring接口的暴露，在实例化bean的阶段我们可以进行一些额外的处理，这些额外的处理只需要让bean实现对应的接口即可，那么spring就会在bean的生命周期调用我们实现的接口来处理该bean。[非常重要]</p>
<hr>
<h2 id="工厂方法">工厂方法</h2>
<h3 id="b-style-color-skyblue-实现方式：-b-2"><b style="color:skyblue">实现方式：</b></h3>
<p>FactoryBean接口。</p>
<h3 id="b-style-color-skyblue-实现原理：-b-2"><b style="color:skyblue">实现原理：</b></h3>
<p>实现了FactoryBean接口的bean是一类叫做factory的bean。其特点是，spring会在使用getBean()<br>
调用获得该bean时，会自动调用该bean的getObject()方法，所以返回的不是factory这个bean，而是这个bean.getOjbect()方法的返回值。</p>
<h3 id="b-style-color-skyblue-例子：-b"><b style="color:skyblue">例子：</b></h3>
<p>典型的例子有spring与mybatis的结合。</p>
<p><strong>代码示例</strong>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:config/mybatis-config-masterxml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapperLocations&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:config/mappers/master/*/xml&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>说明</strong>：</p>
<p>我们看上面该bean，因为实现了FactoryBean接口，所以返回的不是 SqlSessionFactoryBean 的实例，而是它的<br>
SqlSessionFactoryBean.getObject() 的返回值。</p>
<hr>
<h2 id="单例模式">单例模式</h2>
<ul>
<li>Spring依赖注入Bean实例默认是单例的。</li>
<li>Spring的依赖注入（包括lazy-init方式）都是发生在AbstractBeanFactory的getBean里。getBean的doGetBean方法调用getSingleton进行bean的创建。</li>
<li>分析getSingleton()方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span>() &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">getSingleton</span><span class="params">(String beanName)</span> &#123;</span><br><span class="line">    <span class="comment">//参数true设置标识允许早期依赖</span></span><br><span class="line">    <span class="keyword">return</span> getSingleton(beanName, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> Object <span class="title function_">getSingleton</span><span class="params">(String beanName, <span class="type">boolean</span> allowEarlyReference)</span> &#123;</span><br><span class="line">    <span class="comment">//检查缓存中是否存在实例</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">singletonObject</span> <span class="operator">=</span> <span class="built_in">this</span>.singletonObjects.get(beanName);</span><br><span class="line">    <span class="keyword">if</span> (singletonObject == <span class="literal">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">      <span class="comment">//如果为空，则锁定全局变量并进行处理。</span></span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="built_in">this</span>.singletonObjects) &#123;</span><br><span class="line">        <span class="comment">//如果此bean正在加载，则不处理</span></span><br><span class="line">        singletonObject = <span class="built_in">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="literal">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">          <span class="comment">//当某些方法需要提前初始化的时候则会调用addSingleFactory 方法将对应的ObjectFactory初始化策略存储在singletonFactories</span></span><br><span class="line">          ObjectFactory&lt;?&gt; singletonFactory = <span class="built_in">this</span>.singletonFactories.get(beanName);</span><br><span class="line">          <span class="keyword">if</span> (singletonFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//调用预先设定的getObject方法</span></span><br><span class="line">            singletonObject = singletonFactory.getObject();</span><br><span class="line">            <span class="comment">//记录在缓存中，earlySingletonObjects和singletonFactories互斥</span></span><br><span class="line">            <span class="built_in">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">            <span class="built_in">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>getSingleton()过程图</li>
</ul>
<p>ps：spring依赖注入时，使用了 双重判断加锁 的单例模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">s[[singletonObjects +getBeanName&lt;&gt;]] ==&gt;</span><br><span class="line">e[[earlySingletonObjects +getBeanName&lt;&gt;]] ==&gt;</span><br><span class="line">f[[singletonFactories +getObject&lt;&gt;]] ==&gt;</span><br><span class="line">创[[创建单例实例]] ===&gt;|remove|f</span><br><span class="line">创 ==&gt;|put|e</span><br></pre></td></tr></table></figure>
<h3 id="b-style-color-skyblue-总结：-b"><b style="color:skyblue">总结：</b></h3>
<p><strong>单例模式定义</strong>： 保证一个类仅有一个实例，并提供一个访问它的全局访问点。</p>
<p><strong>spring对单例的实现</strong>： spring中的单例模式完成了后半句话，即提供了全局的访问点BeanFactory。但没有从构造器级别去控制单例，这是因为spring管理的是任意的java对象。</p>
<hr>
<h2 id="适配器模式">适配器模式</h2>
<h3 id="b-style-color-skyblue-实现方式：-b-3"><b style="color:skyblue">实现方式：</b></h3>
<p>SpringMVC中的适配器HandlerAdatper。</p>
<h3 id="b-style-color-skyblue-实现原理：-b-3"><b style="color:skyblue">实现原理：</b></h3>
<p>HandlerAdatper根据Handler规则执行不同的Handler。</p>
<h3 id="b-style-color-skyblue-实现过程：-b"><b style="color:skyblue">实现过程：</b></h3>
<p>DispatcherServlet根据HandlerMapping返回的handler，向HandlerAdatper发起请求，处理Handler。</p>
<p>HandlerAdapter根据规则找到对应的Handler并让其执行，执行完毕后Handler会向HandlerAdapter返回一个ModelAndView，最后由HandlerAdapter向DispatchServelet返回一个ModelAndView。</p>
<h3 id="b-style-color-skyblue-实现意义：-b"><b style="color:skyblue">实现意义：</b></h3>
<p>HandlerAdatper使得Handler的扩展变得容易，只需要增加一个新的Handler和一个对应的HandlerAdapter即可。</p>
<p>因此Spring定义了一个适配接口，使得每一种Controller有一种对应的适配器实现类，让适配器代替controller执行相应的方法。这样在扩展Controller时，只需要增加一个适配器类就完成了SpringMVC的扩展了。</p>
<hr>
<h2 id="装饰器模式">装饰器模式</h2>
<h3 id="b-style-color-skyblue-实现方式：-b-4"><b style="color:skyblue">实现方式：</b></h3>
<p>Spring中用到的包装器模式在类名上有两种表现：一种是类名中含有Wrapper，另一种是类名中含有Decorator。</p>
<h3 id="b-style-color-skyblue-实质：-b-2"><b style="color:skyblue">实质：</b></h3>
<p>动态地给一个对象添加一些额外的职责。</p>
<p>就增加功能来说，Decorator模式相比生成子类更为灵活。</p>
<hr>
<h2 id="代理模式">代理模式</h2>
<h3 id="b-style-color-skyblue-实现方式：-b-5"><b style="color:skyblue">实现方式：</b></h3>
<p>AOP底层，就是动态代理模式的实现。</p>
<ul>
<li>动态代理：在内存中构建的，不需要手动编写代理类</li>
<li>静态代理：需要手工编写代理类，代理类引用被代理对象。</li>
</ul>
<h3 id="b-style-color-skyblue-实现原理：-b-4"><b style="color:skyblue">实现原理：</b></h3>
<p>切面在应用运行的时刻被织入。一般情况下，在织入切面时，AOP容器会为目标对象创建动态的创建一个代理对象。SpringAOP就是以这种方式织入切面的。</p>
<p>织入：把切面应用到目标对象并创建新的代理对象的过程。</p>
<hr>
<h2 id="观察者模式">观察者模式</h2>
<h3 id="b-style-color-skyblue-实现方式：-b-6"><b style="color:skyblue">实现方式：</b></h3>
<p>spring的事件驱动模型使用的是 观察者模式 ，Spring中Observer模式常用的地方是listener的实现。</p>
<h3 id="b-style-color-skyblue-具体实现：-b"><b style="color:skyblue">具体实现：</b></h3>
<p>事件机制的实现需要三个部分,事件源,事件,事件监听器</p>
<p>(1) ApplicationEvent抽象类[事件]</p>
<ul>
<li>继承自jdk的EventObject,所有的事件都需要继承ApplicationEvent,并且通过构造器参数source得到事件源.</li>
<li>该类的实现类ApplicationContextEvent表示ApplicationContext的容器事件.</li>
<li>代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ApplicationEvent</span> <span class="keyword">extends</span> <span class="title class_">EventObject</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7099057708183571937L</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> timestamp;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">ApplicationEvent</span><span class="params">(Object source)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(source);</span><br><span class="line">    <span class="built_in">this</span>.timestamp = System.currentTimeMillis();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> <span class="title function_">getTimestamp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.timestamp;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(2)ApplicationListener接口[事件监听器]</p>
<ul>
<li>继承自jdk的EventListener,所有的监听器都要实现这个接口。</li>
<li>这个接口只有一个onApplicationEvent()方法,该方法接受一个ApplicationEvent或其子类对象作为参数,在方法体中,可以通过不同对Event类的判断来进行相应的处理。</li>
<li>当事件触发时所有的监听器都会收到消息。</li>
<li>代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApplicationListener</span>&lt;E <span class="keyword">extends</span> <span class="title class_">ApplicationEvent</span>&gt; <span class="keyword">extends</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(E event)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(3) ApplicationContext接口[事件源]</p>
<ul>
<li>ApplicationContext是spring中的全局容器，翻译过来是”应用上下文”。</li>
<li>实现了ApplicationEventPublisher接口。</li>
<li>职责：负责读取bean的配置文档,管理bean的加载,维护bean之间的依赖关系,可以说是负责bean的整个生命周期,再通俗一点就是我们平时所说的IOC容器。</li>
<li>代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ApplicationEventPublisher</span> &#123;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">publishEvent</span><span class="params">(ApplicationEvent event)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventPublisher</span> <span class="keyword">implements</span> <span class="title class_">ApplicationEventPublisher</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publishEvent</span><span class="params">(ApplicationEvent event)</span> &#123;</span><br><span class="line">    Assert.notNull(event, <span class="string">&quot;Event must not be null&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">      logger.trace(<span class="string">&quot;Publishing event in &quot;</span> + getDisplayName() + <span class="string">&quot;: &quot;</span> + event);</span><br><span class="line">    &#125;</span><br><span class="line">    getApplicationEventMulticaster().multicastEvent(event);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.parent != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.parent.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>(4)ApplicationEventMulticaster抽象类[事件源中publishEvent方法需要调用其方法getApplicationEventMulticaster]</p>
<ul>
<li>属于事件广播器,它的作用是把ApplicationContext发布的Event广播给所有的监听器.</li>
<li>代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractApplicationContext</span> <span class="keyword">extends</span> <span class="title class_">DefaultResourceLoader</span></span><br><span class="line">  <span class="keyword">implements</span> <span class="title class_">ConfigurableApplicationContext</span>, DisposableBean &#123;</span><br><span class="line">  <span class="keyword">private</span> ApplicationEventMulticaster applicationEventMulticaster;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">registerListeners</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Register statically specified listeners first.</span></span><br><span class="line">    <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">      getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span></span><br><span class="line">    <span class="comment">// uninitialized to let post-processors apply to them!</span></span><br><span class="line">    String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String lisName : listenerBeanNames) &#123;</span><br><span class="line">      getApplicationEventMulticaster().addApplicationListenerBean(lisName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="策略模式">策略模式</h2>
<h3 id="b-style-color-skyblue-实现方式：-b-7"><b style="color:skyblue">实现方式：</b></h3>
<p>Spring框架的资源访问Resource接口。该接口提供了更强的资源访问能力，Spring 框架本身大量使用了 Resource 接口来访问底层资源。</p>
<h3 id="b-style-color-skyblue-Resource-接口介绍-b"><b style="color:skyblue">Resource 接口介绍</b></h3>
<p>source 接口是具体资源访问策略的抽象，也是所有资源访问类所实现的接口。</p>
<p>Resource 接口主要提供了如下几个方法:</p>
<ul>
<li><strong>getInputStream()</strong>： 定位并打开资源，返回资源对应的输入流。每次调用都返回新的输入流。调用者必须负责关闭输入流。</li>
<li><strong>exists()</strong>： 返回 Resource 所指向的资源是否存在。</li>
<li><strong>isOpen()</strong>： 返回资源文件是否打开，如果资源文件不能多次读取，每次读取结束应该显式关闭，以防止资源泄漏。</li>
<li><strong>getDescription()</strong>： 返回资源的描述信息，通常用于资源处理出错时输出该信息，通常是全限定文件名或实际 URL。</li>
<li><strong>getFile</strong>： 返回资源对应的 File 对象。</li>
<li><strong>getURL</strong>： 返回资源对应的 URL 对象。<br>
最后两个方法通常无须使用，仅在通过简单方式访问无法实现时，Resource 提供传统的资源访问的功能。</li>
</ul>
<p>Resource 接口本身没有提供访问任何底层资源的实现逻辑，<strong>针对不同的底层资源，Spring 将会提供不同的 Resource<br>
实现类，不同的实现类负责不同的资源访问逻辑。</strong></p>
<p>Spring 为 Resource 接口提供了如下实现类：</p>
<ul>
<li><strong>UrlResource</strong>： 访问网络资源的实现类。</li>
<li><strong>ClassPathResource</strong>： 访问类加载路径里资源的实现类。</li>
<li><strong>FileSystemResource</strong>： 访问文件系统里资源的实现类。</li>
<li><strong>ServletContextResource</strong>： 访问相对于 ServletContext 路径里的资源的实现类.</li>
<li><strong>InputStreamResource</strong>： 访问输入流资源的实现类。</li>
<li><strong>ByteArrayResource</strong>： 访问字节数组资源的实现类。<br>
这些 Resource 实现类，针对不同的的底层资源，提供了相应的资源访问逻辑，并提供便捷的包装，以利于客户端程序的资源访问。</li>
</ul>
<hr>
<h2 id="模版方法模式">模版方法模式</h2>
<h3 id="b-style-color-skyblue-经典模板方法定义：-b"><b style="color:skyblue">经典模板方法定义：</b></h3>
<p>父类定义了骨架（调用哪些方法及顺序），某些特定方法由子类实现。</p>
<p>最大的好处：代码复用，减少重复代码。除了子类要实现的特定方法，其他方法及方法调用顺序都在父类中预先写好了。</p>
<p><strong>所以父类模板方法中有两类方法</strong>：</p>
<p><strong>共同的方法</strong>： 所有子类都会用到的代码</p>
<p><strong>不同的方法</strong>： 子类要覆盖的方法，分为两种：</p>
<p>抽象方法：父类中的是抽象方法，子类必须覆盖<br>
钩子方法：父类中是一个空方法，子类继承了默认也是空的<br>
注：为什么叫钩子，子类可以通过这个钩子（方法），控制父类，因为这个钩子实际是父类的方法（空方法）！</p>
<h3 id="b-style-color-skyblue-Spring模板方法模式实质：-b"><b style="color:skyblue">Spring模板方法模式实质：</b></h3>
<p>是模板方法模式和回调模式的结合，是Template Method不需要继承的另一种实现方式。Spring几乎所有的外接扩展都采用这种模式。</p>
<h3 id="b-style-color-skyblue-具体实现：-b-2"><b style="color:skyblue">具体实现：</b></h3>
<p>JDBC的抽象和对Hibernate的集成，都采用了一种理念或者处理方式，那就是模板方法模式与相应的Callback接口相结合。</p>
<p>采用模板方法模式是为了以一种统一而集中的方式来处理资源的获取和释放，以JdbcTemplate为例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">JdbcTemplate</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">execute</span><span class="params">(String sql)</span> &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      con = getConnection();</span><br><span class="line">      stmt = con.createStatement();</span><br><span class="line">      <span class="type">Object</span> <span class="variable">retValue</span> <span class="operator">=</span> executeWithStatement(stmt, sql);</span><br><span class="line">      <span class="keyword">return</span> retValue;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      closeStatement(stmt);</span><br><span class="line">      releaseConnection(con);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title function_">executeWithStatement</span><span class="params">(Statement stmt, String sql)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="b-style-color-skyblue-引入回调原因：-b"><b style="color:skyblue">引入回调原因：</b></h3>
<p>JdbcTemplate是抽象类，不能够独立使用，我们每次进行数据访问的时候都要给出一个相应的子类实现,这样肯定不方便，所以就引入了回调。</p>
<p>回调代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StatementCallback</span> &#123;</span><br><span class="line">  Object <span class="title function_">doWithStatement</span><span class="params">(Statement stmt)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用回调方法重写JdbcTemplate方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcTemplate</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">execute</span><span class="params">(StatementCallback callback)</span> &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      con = getConnection();</span><br><span class="line">      stmt = con.createStatement();</span><br><span class="line">      <span class="type">Object</span> <span class="variable">retValue</span> <span class="operator">=</span> callback.doWithStatement(stmt);</span><br><span class="line">      <span class="keyword">return</span> retValue;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      closeStatement(stmt);</span><br><span class="line">      releaseConnection(con);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//其它方法定义...</span></span><br></pre></td></tr></table></figure>
<h3 id="b-style-color-skyblue-为什么JdbcTemplate没有使用继承？-b"><b style="color:skyblue">为什么JdbcTemplate没有使用继承？</b></h3>
<p>因为这个类的方法太多，但是我们还是想用到JdbcTemplate已有的稳定的、公用的数据库连接，那么我们怎么办呢？</p>
<p>我们可以把变化的东西抽出来作为一个参数传入JdbcTemplate的方法中。但是变化的东西是一段代码，而且这段代码会用到JdbcTemplate中的变量。怎么办？</p>
<p>那我们就用回调对象吧。在这个回调对象中定义一个操纵JdbcTemplate中变量的方法，我们去实现这个方法，就把变化的东西集中到这里了。然后我们再传入这个回调对象到JdbcTemplate，从而完成了调用。</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-08-18</span><a class="tag" href="/categories/设计模式/" title="设计模式">设计模式 </a><i class="fa fa-tag"></i><a class="tag" href="/tags/设计模式/" title="设计模式">设计模式 </a><span class="leancloud_visitors"></span><span>About 3648 words, 12 min 9 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/08/18/spring-aop/">Spring AOP 笔记</a></h3></div><div class="post-content"><div class="card"><p><hr>
<h2 id="README">README</h2>
<blockquote>
<p>AOP 的使用，基本上都会涉及到自定义注解，一种非常常见的组合，就是自定义注解+AOP。</p>
</blockquote>
<blockquote>
<p>在开发中，AOP最大的作用就是重复代码简化。</p>
</blockquote>
<ol>
<li>首先，自定义一个注解。</li>
<li>定义 AOP 切面，在切面中，定义切点和通知，切点，也就是方法的拦截规则，我们可以按照注解来拦截，也就是某一个带有自定义注解的方法，将被我拦截下来。</li>
<li>拦截下来之后，前置通知、后置通知、异常通知、返回通知还是环绕通知。</li>
</ol>
<hr>
<h2 id="幂等性处理">幂等性处理</h2>
<ul>
<li>Token 机制</li>
<li>去重表</li>
<li>利用 Redis  <code>setnx</code></li>
<li>设置状态字段</li>
<li>上锁</li>
</ul>
<ol>
<li>自定义注解。</li>
<li>自定义切点。</li>
<li>定义环绕通知，在环绕通知中，先通过上述五种思路中的任意一种，对方法执行的幂等性进行判断。</li>
</ol>
<hr>
<h2 id="接口限流">接口限流</h2>
<p>推荐成熟方案 <a href="">Alibaba Sentinel</a></p>
<p>思路大致如下：</p>
<ol>
<li>自定义注解。</li>
<li>在需要进行限流的接口方法上添加自定义注解，同时还可以设置一些限流的参数，例如时间窗口值、流量大小等。</li>
<li>自定义切点，拦截到方法之后，在环绕通知中，可以通过 Redis 插件 redis-cell、通过漏斗算法去处理限流。</li>
</ol>
<hr>
<h2 id="日志处理">日志处理</h2>
<p>AOP经典例子</p>
<hr>
<h2 id="多数据源处理">多数据源处理</h2>
<p>自定义多数据源：</p>
<blockquote>
<p>从 Spring2.0.1 中引入了 AbstractRoutingDataSource 类，该类充当了 DataSource 的路由中介，它能够在运行时, 根据某种 key<br>
值来动态切换到真正的 DataSource 上。</p>
<blockquote>
<p>大致的用法是提前准备好各种数据源，存入到一个 Map 中，Map 的 key 就是这个数据源的名字，Map 的 value 就是这个具体的数据源，然后再把这个<br>
Map 配置到 AbstractRoutingDataSource 中，之后，每次执行数据库查询的时候，拿一个 key 出来，AbstractRoutingDataSource<br>
会找到具体的数据源去执行这次数据库操作。</p>
</blockquote>
</blockquote>
<p>思路大致如下：</p>
<ol>
<li>自定义注解。</li>
<li>在需要切换数据源的方法上添加自定义注解。</li>
<li>自定义切点，拦截到方法之后，在环绕通知中，根据注解中的配置，重新设置要执行的数据源。</li>
</ol>
<hr>
<h2 id="方法权限处理">方法权限处理</h2>
<p>推荐成熟方案 <a href="">Spring Security</a></p>
<p>思路大致如下：</p>
<ol>
<li>自定义注解。</li>
<li>在需要进行校验的方法上添加自定义注解。</li>
<li>自定义切点，拦截到方法之后，在环绕通知中，根据注解中的配置，查询处理权限。</li>
</ol>
<hr>
<h2 id="事务处理">事务处理</h2>
<p>Spring 提供注解，对于声明式事务，直接用现成的注解，本质上也是 AOP。</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-08-18</span><a class="tag" href="/categories/Spring-AOP/" title="Spring AOP">Spring AOP </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Spring-AOP/" title="Spring AOP">Spring AOP </a><span class="leancloud_visitors"></span><span>About 741 words, 2 min 28 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/08/18/docker/">Docker 笔记</a></h3></div><div class="post-content"><div class="card"><p><hr>
<h2 id="README">README</h2>
<p>本篇主要记录Docker学习笔记</p>
<hr>
<h2 id="docker-pull-image">docker pull $image</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql</span><br><span class="line"><span class="comment"># Using default tag: latest</span></span><br><span class="line"><span class="comment"># latest: Pulling from library/mysql</span></span><br><span class="line"><span class="comment"># b193354265ba: Pull complete # 分层下载 联合文件系统</span></span><br><span class="line"><span class="comment"># 14a15c0bb358: Already exists # 分层下载 联合文件系统 可以和其他镜像共用</span></span><br><span class="line"><span class="comment"># 02da291ad1e4: Pull complete </span></span><br><span class="line"><span class="comment"># 9a89a1d664ee: Pull complete </span></span><br><span class="line"><span class="comment"># a24ae6513051: Pull complete </span></span><br><span class="line"><span class="comment"># b85424247193: Pull complete </span></span><br><span class="line"><span class="comment"># 9a240a3b3d51: Pull complete </span></span><br><span class="line"><span class="comment"># 8bf57120f71f: Pull complete </span></span><br><span class="line"><span class="comment"># c64090e82a0b: Pull complete </span></span><br><span class="line"><span class="comment"># af7c7515d542: Pull complete </span></span><br><span class="line"><span class="comment"># Digest: sha256:c0455ac041844b5e65cd08571387fa5b50ab2a6179557fd938298cab13acf0dd # 签名</span></span><br><span class="line"><span class="comment"># Status: Downloaded newer image for mysql:latest</span></span><br><span class="line"><span class="comment"># docker.io/library/mysql:latest #真实地址 等价 docker pull mysql</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="两种进入容器的方法">两种进入容器的方法</h2>
<h3 id="进入容器内部-开启一个新终端">进入容器内部 开启一个新终端</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it <span class="variable">$container</span> /bin/bash</span><br></pre></td></tr></table></figure>
<h3 id="进入容器内部-进入正在执行的容器终端-不开启新终端">进入容器内部 进入正在执行的容器终端 不开启新终端</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker attach <span class="variable">$container</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="拷贝文件">拷贝文件</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> <span class="variable">$container</span>:<span class="variable">$path</span> <span class="variable">$path</span></span><br></pre></td></tr></table></figure>
<p>拷贝容器内文件到主机</p>
<hr>
<h2 id="运行挂载容器卷">运行挂载容器卷</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -v <span class="variable">$name</span>:/etc/nginx:ro nginx --volumes-from mysql</span><br></pre></td></tr></table></figure>
<p>具名挂载：默认目录 /var/lib/docker/volumes/$name/_data</p>
<p>匿名挂载：不填<code>$name</code>:</p>
<p><code>:ro</code> readonly 只能容器外部修改</p>
<p><code>:rw</code> readwrite</p>
<p><code>--volumes-from</code> 跟随挂载 例子可以实现多个mysql容器数据同步</p>
<hr>
<h2 id="docker-inspect-container">docker inspect $container</h2>
<p>信息</p>
<hr>
<h2 id="docker-history-image">docker history $image</h2>
<p>查看镜像历史构建步骤</p>
<hr>
<h2 id="Dockerfile">Dockerfile</h2>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ADD</td>
<td>添加文件进去</td>
</tr>
<tr>
<td>COPY</td>
<td>添加文件进去</td>
</tr>
<tr>
<td>RUN</td>
<td>镜像构建时运行的命令</td>
</tr>
<tr>
<td>CMD</td>
<td>容器启动时运行的命令，会被外部参数替换</td>
</tr>
<tr>
<td>ENTRYPOINT</td>
<td>容器启动时运行的命令，可以追加</td>
</tr>
<tr>
<td>ENV</td>
<td>构建时设置环境变量</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="CMD-和-ENTRYPOINT-区别">CMD 和 ENTRYPOINT 区别</h3>
<p>两者都是设置某容器启动时要执行的命令</p>
<p>举例如下：</p>
<p>构建 centos 镜像，打印当前目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile</span></span><br><span class="line">FROM centos</span><br><span class="line">CMD [<span class="string">&quot;ls&quot;</span>,<span class="string">&quot;-a&quot;</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build .</span><br><span class="line">docker run <span class="variable">$container</span> -l</span><br></pre></td></tr></table></figure>
<p><u>CMD</u></p>
<p>会报错，因为 <code>ls -a</code> 被替换成了 <code>-l</code></p>
<p><u>ENTRYPOINT</u></p>
<p>无报错，可以正常打印当前目录信息，因为 <code>ls -a</code> 被追加成了 <code>ls -la</code></p>
<hr>
<h3 id="Dockerfile-例子">Dockerfile 例子</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.7-alpine</span><br><span class="line">WORKDIR /code</span><br><span class="line">ENV FLASK_APP=app.py</span><br><span class="line">ENV FLASK_RUN_HOST=0.0.0.0</span><br><span class="line">RUN apk add --no-cache gcc musl-dev linux-headers</span><br><span class="line">COPY requirements.txt requirements.txt</span><br><span class="line">RUN pip install -r requirements.txt</span><br><span class="line">EXPOSE 5000</span><br><span class="line">COPY . .</span><br><span class="line">CMD [<span class="string">&quot;flask&quot;</span>, <span class="string">&quot;run&quot;</span>]</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="网络">网络</h2>
<p><img src="/images/docker-net.png" alt="image-20230821160035004"></p>
<hr>
<h3 id="容器互联">容器互联</h3>
<p><code>--link</code></p>
<p>只是在host中添加配置，不推荐使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -P --name centos01 --<span class="built_in">link</span> centos02 centos</span><br><span class="line">docker run -d -P --name centos02 centos</span><br><span class="line"><span class="comment"># Ping 成功</span></span><br><span class="line">docker <span class="built_in">exec</span> -it centos01 ping centos02</span><br><span class="line"><span class="comment"># Ping 失败 因为02 host 中没配置01的信息</span></span><br><span class="line">docker <span class="built_in">exec</span> -it centos02 ping centos01</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="自定义网络">自定义网络</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker network create --driver=bridge --subnet=192.168.0.0/16 --gateway=192.168.0.1 my-net</span><br><span class="line">docker run -d -P --name=centos01 --net=mynet centos</span><br><span class="line">docker run -d -P --name=centos02 --net=mynet centos</span><br><span class="line"><span class="comment"># 自定义网络可以直接ping名字，不需要--link</span></span><br><span class="line">docker <span class="built_in">exec</span> -it centos01 ping centos02</span><br></pre></td></tr></table></figure>
<p>自定义网络中每个节点关系已经自动维护好了。</p>
<p>不同的集群，比如<code>redis</code>集群或者<code>mysql</code>集群，使用不同的自定义网络，互相隔离开来。</p>
<hr>
<h3 id="网络联通">网络联通</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将centos01放到my-net下</span></span><br><span class="line"><span class="comment"># 一个容器两个ip</span></span><br><span class="line">docker network connect my-net centos01</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Compose">Compose</h2>
<h3 id="安装">安装</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">curl -L https://get.daocloud.io/docker/compose/releases/download/1.26.2/docker-compose-`<span class="built_in">uname</span> -s`-`<span class="built_in">uname</span> -m` &gt; /usr/local/bin/docker-compose</span><br><span class="line"><span class="comment"># 授权</span></span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line"><span class="comment"># v</span></span><br><span class="line">docker-compose version</span><br></pre></td></tr></table></figure>
<h3 id="命令">命令</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># up</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"><span class="comment"># down</span></span><br><span class="line">docker-compose down</span><br></pre></td></tr></table></figure>
<h3 id="样例">样例</h3>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">volumes:</span> <span class="comment"># 挂载</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db_data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">somewordpress</span> <span class="comment"># root用户 的 密码</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">wordpress</span> <span class="comment"># 数据库名</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">wordpress</span> <span class="comment"># 数据库用户</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">wordpress</span> <span class="comment"># 数据库密码</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">wordpress:</span></span><br><span class="line">    <span class="attr">depends_on:</span> <span class="comment"># 依赖项</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wordpress:latest</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">wordpress_data:/var/www/html</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:80&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_HOST:</span> <span class="string">db</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_USER:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_NAME:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db_data:</span> &#123; &#125;</span><br><span class="line">  <span class="attr">wordpress_data:</span> &#123; &#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Swarm">Swarm</h2>
<p>准备四台服务器</p>
<p>简化版K8S</p>
<hr>
<h3 id="设置主节点">设置主节点</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr 192.168.64.134</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="生成令牌">生成令牌</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成管理节点的令牌</span></span><br><span class="line">docker swarm join-token manager</span><br><span class="line"><span class="comment"># 生成工作节点的令牌</span></span><br><span class="line">docker swarm join-token worker</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="设置工作节点">设置工作节点</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 135</span></span><br><span class="line">docker swarm <span class="built_in">join</span> --token SWMTKN-1-56fs1oaww5jkhsq7f3v2f3fazgm1jgxrvjc1n4cttab8v6bmr8-04efiil88xkppw186vk82y5f1 192.168.64.135:2377</span><br><span class="line"><span class="comment"># 136</span></span><br><span class="line">docker swarm <span class="built_in">join</span> --token SWMTKN-1-56fs1oaww5jkhsq7f3v2f3fazgm1jgxrvjc1n4cttab8v6bmr8-04efiil88xkppw186vk82y5f1 192.168.64.136:2377</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="设置管理节点">设置管理节点</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 137</span></span><br><span class="line">docker swarm <span class="built_in">join</span> --token SWMTKN-1-56fs1oaww5jkhsq7f3v2f3fazgm1jgxrvjc1n4cttab8v6bmr8-4bocoqdhfypuppql3yqxt0u2p 192.168.64.134:2377</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="查看所有节点">查看所有节点</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@192 ~]<span class="comment"># docker node ls</span></span><br><span class="line"><span class="comment"># ID                            HOSTNAME         STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span></span><br><span class="line"><span class="comment"># n2ws0fm7fvsiniuo9wjmq3dfh *   192.168.64.134   Ready     Active         Leader           20.10.12</span></span><br><span class="line"><span class="comment"># y1clyylemoiqbrquha4hpgdg7     192.168.64.135   Ready     Active                          20.10.12</span></span><br><span class="line"><span class="comment"># 29g0dvdvrtajsxr5d6lgutddr     192.168.64.136   Ready     Active                          20.10.12</span></span><br><span class="line"><span class="comment"># mbtufs92q1q1kbsrdkfh3gx7s     192.168.64.137   Ready     Active         Reachable        20.10.12</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Raft协议">Raft协议</h3>
<p>Raft协议：保证大多数节点存活才可用</p>
<p>三个管理器的集群最多可以容忍一个节点的丢失。<br>
五个管理器的集群可以容忍最大同时丢失两个节点。<br>
N个管理器集群最多可以容忍丢失(N-1)/2个节点。<br>
Docker 建议一个集群有七个节点。</p>
<hr>
<h3 id="创建服务">创建服务</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker service create -p 80:80 nginx</span><br><span class="line">docker service <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># ID             NAME       MODE         REPLICAS   IMAGE          PORTS</span></span><br><span class="line"><span class="comment"># cccvbtrm38lt   nginx      replicated   1/1        nginx:latest   *:8888-&gt;80/tcp</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="动态扩容">动态扩容</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker service scale nginx=3 </span></span><br><span class="line">docker service update --replicas 3 nginx</span><br><span class="line"><span class="comment"># nginx</span></span><br><span class="line"><span class="comment"># overall progress: 3 out of 3 tasks </span></span><br><span class="line"><span class="comment"># 1/3: running   </span></span><br><span class="line"><span class="comment"># 2/3: running   </span></span><br><span class="line"><span class="comment"># 3/3: running   </span></span><br><span class="line"><span class="comment"># verify: Service converged </span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="动态缩容">动态缩容</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service scale nginx=1</span><br></pre></td></tr></table></figure></p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-08-18</span><a class="tag" href="/categories/Docker/" title="Docker">Docker </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Docker/" title="Docker">Docker </a><span class="leancloud_visitors"></span><span>About 1198 words, 3 min 59 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/08/16/hexo-init/">通过 GitHub 搭建个人博客 Hexo</a></h3></div><div class="post-content"><div class="card"><p><hr>
<h2 id="README">README</h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">https://hexo.io/zh-cn/</a></p>
</blockquote>
<p>安装之前确认好要安装的 Hexo 版本所对应的 Node 最低需求</p>
<p>例如 <code>Hexo 6.3.0</code> 最低支持 <code>node 14</code> 构建</p>
<!--suppress HtmlUnknownTarget -->
<img src="/images/hexo-init-001.png" alt="image-20230817154901378" style="zoom:67%" />
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/hexo/v/6.3.0">https://www.npmjs.com/package/hexo/v/6.3.0</a></p>
</blockquote>
<hr>
<h2 id="安装-Hexo">安装 Hexo</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="建站">建站</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo init &lt;folder&gt;</span><br><span class="line"><span class="built_in">cd</span> &lt;folder&gt;</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="本地运行">本地运行</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure>
<p>访问 localhost:4000</p>
<hr>
<h2 id="部署">部署</h2>
<p>部署到 GitHub Pages</p>
<p>修改 <code>_config.yml</code> 替换添加如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: git@github.com:$username/$username.github.io.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>
<p>最后执行三连。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>
<p>访问 <code>$username.github.io</code></p>
<p>仓库名称需要设置成 <code>$username.github.io</code> 的格式</p>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-08-16</span><a class="tag" href="/categories/Hexo/" title="Hexo">Hexo </a><i class="fa fa-tag"></i><a class="tag" href="/tags/GitHub/" title="GitHub">GitHub </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Hexo/" title="Hexo">Hexo </a><span class="leancloud_visitors"></span><span>About 148 words, 29 sec  read</span></div></div></div></div><div class="post animated fadeInDown"><div class="post-title"><h3><a href="/2023/08/16/github-ssh/">Windows 生成及配置 GitHub SSH</a></h3></div><div class="post-content"><div class="card"><p><hr>
<h2 id="README">README</h2>
<p>本篇主要记录Windows环境，生成及配置非默认、具有别名的SSH keys。</p>
<blockquote>
<p>id_ed25519.pub 这种以默认的名称命名的公钥文件，不需要额外配置即可自动识别。</p>
<p>github_olive.pub 这种自定义key的公钥文件，需要在ssh-agent中添加才可被识别。</p>
</blockquote>
<hr>
<h2 id="Generate-SSH">Generate SSH</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> C:\Users\olive\.ssh</span><br><span class="line">ssh-keygen -t ed25519 -C <span class="string">&quot;&lt;your github email&gt;&quot;</span></span><br><span class="line"><span class="comment"># Generating public/private ed25519 key pair.</span></span><br><span class="line"><span class="comment"># Enter file in which to save the key (C:\Users\olive/.ssh/id_ed25519): github_olive</span></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="comment"># 2023/08/16  15:43               411 github_olive</span></span><br><span class="line"><span class="comment"># 2023/08/16  15:43                98 github_olive.pub</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Github-配置-SSH-keys">Github 配置 SSH keys</h2>
<p>Setting -&gt; SSH and GPG keys -&gt; New SSH key</p>
<hr>
<h2 id="本地测试是否配置成功">本地测试是否配置成功</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -T <span class="string">&quot;git@github.com&quot;</span></span><br><span class="line"><span class="comment"># git@github.com: Permission denied (publickey).</span></span><br></pre></td></tr></table></figure>
<p>具体原因看README。</p>
<hr>
<h2 id="配置-Config-文件">配置 Config 文件</h2>
<p><code>ssh-agent &amp; ssh-add</code> 我实践配置只在当前窗口生效，</p>
<blockquote>
<p>$ eval “$(ssh-agent -s)”<br>
Agent pid 555<br>
ssh-add ~/.ssh/github_olive</p>
</blockquote>
<p>所以目前选择配置 SSH Config 文件</p>
<p>config 文件位置及内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> C:\Users\olive\.ssh</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="comment"># 2023/08/16  15:43                 1 config</span></span><br><span class="line"><span class="comment"># 2023/08/16  15:43               411 github_olive</span></span><br><span class="line"><span class="comment"># 2023/08/16  15:43                98 github_olive.pub</span></span><br><span class="line">vim config</span><br><span class="line"><span class="comment"># Host github.com</span></span><br><span class="line"><span class="comment"># HostName github.com</span></span><br><span class="line"><span class="comment"># PreferredAuthentications publickey</span></span><br><span class="line"><span class="comment"># IdentityFile ~/.ssh/github_olive</span></span><br></pre></td></tr></table></figure>
<p>再次测试是否授权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -T <span class="string">&quot;git@github.com&quot;</span></span><br><span class="line"><span class="comment"># Hi olive! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span></span><br></pre></td></tr></table></figure>
</p></div></div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-08-16</span><a class="tag" href="/categories/SSH/" title="SSH">SSH </a><i class="fa fa-tag"></i><a class="tag" href="/tags/GitHub/" title="GitHub">GitHub </a><i class="fa fa-tag"></i><a class="tag" href="/tags/Git/" title="Git">Git </a><i class="fa fa-tag"></i><a class="tag" href="/tags/SSH/" title="SSH">SSH </a><span class="leancloud_visitors"></span><span>About 292 words, 58 sec  read</span></div></div></div></div><div class="pagination"><ul class="clearfix"></ul></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>